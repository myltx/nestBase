import{_ as i,c as a,o as l,a0 as e}from"./chunks/framework.CHkYM5Ax.js";const c=JSON.parse('{"title":"用户-角色管理接口文档","description":"","frontmatter":{},"headers":[],"relativePath":"backend/guides/API_USER_ROLES.md","filePath":"backend/guides/API_USER_ROLES.md","lastUpdated":1762852082000}'),t={name:"backend/guides/API_USER_ROLES.md"};function n(h,s,p,o,k,d){return l(),a("div",null,[...s[0]||(s[0]=[e(`<h1 id="用户-角色管理接口文档" tabindex="-1">用户-角色管理接口文档 <a class="header-anchor" href="#用户-角色管理接口文档" aria-label="Permalink to &quot;用户-角色管理接口文档&quot;">​</a></h1><blockquote><p>适配需求：</p><ol><li>用户管理页：编辑用户 → 修改角色；</li><li>角色管理页：编辑角色 → 批量添加/移除用户、查看用户分布。</li></ol></blockquote><ul><li>基础路径：<code>/api</code>（由环境变量 <code>API_PREFIX</code> 控制，默认 <code>api</code>）</li><li>认证：默认需携带 JWT；如需公开，请在控制器方法上添加 <code>@Public()</code></li><li>统一响应：由全局拦截器包装 <code>{ code, success, data, message, timestamp }</code></li><li>权限建议： <ul><li>修改用户角色：<code>user.update</code></li><li>角色批量用户管理：<code>role.manage</code></li></ul></li></ul><hr><h2 id="一、接口列表" tabindex="-1">一、接口列表 <a class="header-anchor" href="#一、接口列表" aria-label="Permalink to &quot;一、接口列表&quot;">​</a></h2><h3 id="_1-用户侧-编辑用户-→-修改角色" tabindex="-1">1. 用户侧（编辑用户 → 修改角色） <a class="header-anchor" href="#_1-用户侧-编辑用户-→-修改角色" aria-label="Permalink to &quot;1. 用户侧（编辑用户 → 修改角色）&quot;">​</a></h3><ul><li><code>GET /api/users/:id/roles</code><ul><li>说明：获取指定用户的角色列表</li></ul></li><li><code>PUT /api/users/:id/roles</code><ul><li>说明：设置指定用户的角色（完全替换）</li><li>Body（三选一，按你使用的数据建模）： <ul><li><code>{ &quot;roleIds&quot;: string[] }</code> 角色表ID列表（关系表建模）</li><li><code>{ &quot;roleKeys&quot;: string[] }</code> 角色编码/唯一键列表（关系表建模）</li><li><code>{ &quot;roles&quot;: string[] }</code> 角色枚举名列表（User.roles 为 enum[] 时）</li></ul></li></ul></li></ul><h3 id="_2-角色侧-编辑角色-→-批量添加-移除用户、查看分布" tabindex="-1">2. 角色侧（编辑角色 → 批量添加/移除用户、查看分布） <a class="header-anchor" href="#_2-角色侧-编辑角色-→-批量添加-移除用户、查看分布" aria-label="Permalink to &quot;2. 角色侧（编辑角色 → 批量添加/移除用户、查看分布）&quot;">​</a></h3><ul><li><code>GET /api/roles/:id/users</code><ul><li>说明：查看角色下的用户（分页/搜索）</li><li>Query：<code>page?</code>、<code>pageSize?</code>、<code>search?</code></li></ul></li><li>说明：<code>:id</code> 可为角色ID/编码/枚举名，服务端会自动识别（关系失败时回退为枚举查询）</li><li><code>POST /api/roles/:id/users</code><ul><li>说明：批量将用户加入该角色</li><li>Body：<code>{ &quot;userIds&quot;: string[] }</code></li></ul></li><li><code>DELETE /api/roles/:id/users</code><ul><li>说明：批量将用户从该角色移除</li><li>Body：<code>{ &quot;userIds&quot;: string[] }</code></li></ul></li></ul><hr><h2 id="二、请求-响应示例" tabindex="-1">二、请求/响应示例 <a class="header-anchor" href="#二、请求-响应示例" aria-label="Permalink to &quot;二、请求/响应示例&quot;">​</a></h2><blockquote><p>以下示例默认为受保护接口，需要携带 <code>Authorization: Bearer &lt;token&gt;</code></p></blockquote><h3 id="_1-修改用户角色-完全替换" tabindex="-1">1) 修改用户角色（完全替换） <a class="header-anchor" href="#_1-修改用户角色-完全替换" aria-label="Permalink to &quot;1) 修改用户角色（完全替换）&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -X</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> PUT</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> http://localhost:3000/api/users/USER_ID/roles</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -H</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Authorization: Bearer YOUR_JWT_TOKEN&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -H</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Content-Type: application/json&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;{</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;roleIds&quot;: [&quot;ROLE_ID_1&quot;, &quot;ROLE_ID_2&quot;]</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  }&#39;</span></span></code></pre></div><blockquote><p>若模型使用枚举数组存储角色，<code>roleIds</code> 应传入枚举名（如 <code>ADMIN</code>、<code>USER</code>）。</p></blockquote><h3 id="_2-批量添加-移除用户到角色" tabindex="-1">2) 批量添加/移除用户到角色 <a class="header-anchor" href="#_2-批量添加-移除用户到角色" aria-label="Permalink to &quot;2) 批量添加/移除用户到角色&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 批量添加</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -X</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> POST</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> http://localhost:3000/api/roles/ROLE_ID/users</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -H</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Authorization: Bearer YOUR_JWT_TOKEN&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -H</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Content-Type: application/json&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;{ &quot;userIds&quot;: [&quot;USER_ID_1&quot;, &quot;USER_ID_2&quot;] }&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 批量移除</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -X</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> DELETE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> http://localhost:3000/api/roles/ROLE_ID/users</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -H</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Authorization: Bearer YOUR_JWT_TOKEN&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -H</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Content-Type: application/json&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;{ &quot;userIds&quot;: [&quot;USER_ID_1&quot;, &quot;USER_ID_3&quot;] }&#39;</span></span></code></pre></div><h3 id="_3-查看角色下用户分布" tabindex="-1">3) 查看角色下用户分布 <a class="header-anchor" href="#_3-查看角色下用户分布" aria-label="Permalink to &quot;3) 查看角色下用户分布&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -X</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> GET</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;http://localhost:3000/api/roles/ROLE_ID/users?page=1&amp;pageSize=20&amp;search=admin&#39;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -H</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Authorization: Bearer YOUR_JWT_TOKEN&quot;</span></span></code></pre></div><p>响应示例：</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;code&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;success&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;data&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;items&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;user-uuid-1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;email&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;admin@example.com&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;username&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;admin&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;total&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">12</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;page&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;pageSize&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;message&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;success&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;timestamp&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2025-01-15T10:00:00.000Z&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><hr><h2 id="三、实现说明-与数据模型的兼容性" tabindex="-1">三、实现说明（与数据模型的兼容性） <a class="header-anchor" href="#三、实现说明-与数据模型的兼容性" aria-label="Permalink to &quot;三、实现说明（与数据模型的兼容性）&quot;">​</a></h2><p>服务端实现兼容两种常见建模：</p><ul><li>多对多关系表：<code>user.roles</code> relation（通过 <code>connect/set/disconnect</code>）</li><li>枚举数组：<code>user.roles</code> enum[]（通过 <code>push/赋值/过滤</code>）</li></ul><p>无需改动前端调用，服务会自动选择适配路径。</p><p>相关服务文件：<code>apps/backend/src/modules/user-roles/user-roles.service.ts</code></p><hr><h2 id="四、权限与限流-已在实现中启用" tabindex="-1">四、权限与限流（已在实现中启用） <a class="header-anchor" href="#四、权限与限流-已在实现中启用" aria-label="Permalink to &quot;四、权限与限流（已在实现中启用）&quot;">​</a></h2><ul><li><p>权限码（RequirePermissions）：</p><ul><li><code>PUT /api/users/:id/roles</code> → <code>user.update</code></li><li><code>POST/DELETE /api/roles/:id/users</code> → <code>role.manage</code></li><li><code>GET /api/roles/:id/users</code> → <code>role.manage</code></li></ul></li><li><p>角色限制（Roles）：</p><ul><li>以上接口均要求 <code>ADMIN</code> 角色</li></ul></li><li><p>限流（RateLimit）：</p><ul><li><code>PUT /api/users/:id/roles</code> → 60s 内最多 10 次/人</li><li><code>POST /api/roles/:id/users</code> → 60s 内最多 5 次/人</li><li><code>DELETE /api/roles/:id/users</code> → 60s 内最多 5 次/人</li></ul></li></ul><p>说明：</p><ul><li>限流以用户 ID 为主键，若无用户信息则退化为 IP；仅对标记了 <code>@RateLimit</code> 的接口生效。</li><li>审计：角色变更操作会写入审计日志（日志输出 + 可选数据库）。</li></ul><hr><h2 id="五、swagger-标签" tabindex="-1">五、Swagger 标签 <a class="header-anchor" href="#五、swagger-标签" aria-label="Permalink to &quot;五、Swagger 标签&quot;">​</a></h2><ul><li>统一归属：<code>@ApiTags(&#39;系统 · 用户角色管理&#39;)</code></li><li>在 Apifox 中会以中文显示该标签，便于归类</li></ul><p>文档入口：<code>/api-docs</code>（由 <code>SWAGGER_PATH</code> 控制，默认 <code>api-docs</code>）。</p><hr><h2 id="六、变更记录" tabindex="-1">六、变更记录 <a class="header-anchor" href="#六、变更记录" aria-label="Permalink to &quot;六、变更记录&quot;">​</a></h2><ul><li>v1.5.0：新增用户-角色关联接口与文档</li></ul>`,39)])])}const u=i(t,[["render",n]]);export{c as __pageData,u as default};
