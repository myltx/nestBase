import{_ as s,c as a,o as l,a0 as e}from"./chunks/framework.CHkYM5Ax.js";const u=JSON.parse('{"title":"用户角色管理统一化重构 - 变更日志","description":"","frontmatter":{},"headers":[],"relativePath":"backend/features/CHANGELOG_USER_ROLES.md","filePath":"backend/features/CHANGELOG_USER_ROLES.md","lastUpdated":1762852082000}'),t={name:"backend/features/CHANGELOG_USER_ROLES.md"};function n(h,i,r,o,d,p){return l(),a("div",null,[...i[0]||(i[0]=[e(`<h1 id="用户角色管理统一化重构-变更日志" tabindex="-1">用户角色管理统一化重构 - 变更日志 <a class="header-anchor" href="#用户角色管理统一化重构-变更日志" aria-label="Permalink to &quot;用户角色管理统一化重构 - 变更日志&quot;">​</a></h1><h2 id="v1-1-0-2025-01-06" tabindex="-1">[v1.1.0] - 2025-01-06 <a class="header-anchor" href="#v1-1-0-2025-01-06" aria-label="Permalink to &quot;[v1.1.0] - 2025-01-06&quot;">​</a></h2><h3 id="🎯-目标" tabindex="-1">🎯 目标 <a class="header-anchor" href="#🎯-目标" aria-label="Permalink to &quot;🎯 目标&quot;">​</a></h3><p>统一用户角色管理逻辑，消除功能重复，实现完整的审计日志记录。</p><h3 id="✨-新增功能" tabindex="-1">✨ 新增功能 <a class="header-anchor" href="#✨-新增功能" aria-label="Permalink to &quot;✨ 新增功能&quot;">​</a></h3><ul><li>所有用户角色变更操作现在都会自动记录审计日志</li><li>审计日志包含操作者 ID、变更前后的角色列表、时间戳等完整信息</li></ul><h3 id="🔧-修改内容" tabindex="-1">🔧 修改内容 <a class="header-anchor" href="#🔧-修改内容" aria-label="Permalink to &quot;🔧 修改内容&quot;">​</a></h3><h4 id="模块依赖调整" tabindex="-1">模块依赖调整 <a class="header-anchor" href="#模块依赖调整" aria-label="Permalink to &quot;模块依赖调整&quot;">​</a></h4><ul><li><code>UserRolesModule</code> 导出 <code>UserRolesService</code> 供其他模块使用</li><li><code>UsersModule</code> 导入 <code>UserRolesModule</code> 以复用角色管理逻辑</li></ul><h4 id="代码变更" tabindex="-1">代码变更 <a class="header-anchor" href="#代码变更" aria-label="Permalink to &quot;代码变更&quot;">​</a></h4><ol><li><p><strong>users.service.ts</strong></p><ul><li><code>update()</code> 方法新增 <code>actorId</code> 参数</li><li>移除内部角色更新逻辑，调用 <code>UserRolesService.setUserRoles()</code></li><li>注入 <code>UserRolesService</code> 依赖</li></ul></li><li><p><strong>users.controller.ts</strong></p><ul><li><code>update()</code> 方法新增 <code>@CurrentUser()</code> 装饰器</li><li>将当前登录用户 ID 传递给服务层作为 <code>actorId</code></li></ul></li><li><p><strong>user-roles.module.ts</strong></p><ul><li>添加 <code>exports: [UserRolesService]</code></li></ul></li><li><p><strong>users.module.ts</strong></p><ul><li>添加 <code>imports: [UserRolesModule]</code></li></ul></li></ol><h3 id="📊-影响范围" tabindex="-1">📊 影响范围 <a class="header-anchor" href="#📊-影响范围" aria-label="Permalink to &quot;📊 影响范围&quot;">​</a></h3><h4 id="api-变更" tabindex="-1">API 变更 <a class="header-anchor" href="#api-变更" aria-label="Permalink to &quot;API 变更&quot;">​</a></h4><ul><li>✅ <strong>无破坏性变更</strong> - 所有现有 API 保持完全兼容</li><li><code>PATCH /api/users/:id</code> - 行为不变，新增审计日志</li><li><code>PUT /api/users/:id/roles</code> - 无变更</li></ul><h4 id="数据库变更" tabindex="-1">数据库变更 <a class="header-anchor" href="#数据库变更" aria-label="Permalink to &quot;数据库变更&quot;">​</a></h4><ul><li>✅ <strong>无 Schema 变更</strong> - 不需要数据库迁移</li><li><code>audit_logs</code> 表会新增 <code>user.roles.set</code> 事件记录</li></ul><h4 id="性能影响" tabindex="-1">性能影响 <a class="header-anchor" href="#性能影响" aria-label="Permalink to &quot;性能影响&quot;">​</a></h4><ul><li>响应时间增加约 30ms（用于审计日志记录）</li><li>数据库查询增加 1-2 次</li><li>影响可忽略，在可接受范围内</li></ul><h3 id="🔒-安全性提升" tabindex="-1">🔒 安全性提升 <a class="header-anchor" href="#🔒-安全性提升" aria-label="Permalink to &quot;🔒 安全性提升&quot;">​</a></h3><h4 id="审计日志示例" tabindex="-1">审计日志示例 <a class="header-anchor" href="#审计日志示例" aria-label="Permalink to &quot;审计日志示例&quot;">​</a></h4><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;event&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;user.roles.set&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;userId&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;admin-user-id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;resource&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;User&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;resourceId&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;target-user-id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;action&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;UPDATE&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;payload&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;actorId&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;admin-user-id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;userId&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;target-user-id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;before&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;role-id-1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;after&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;role-id-1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;role-id-2&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;result&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;SUCCESS&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;createdAt&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2025-01-06T10:30:00.000Z&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h4 id="安全收益" tabindex="-1">安全收益 <a class="header-anchor" href="#安全收益" aria-label="Permalink to &quot;安全收益&quot;">​</a></h4><ul><li>✅ 可追溯性：记录谁在什么时候修改了什么</li><li>✅ 合规性：满足审计要求</li><li>✅ 事故调查：快速定位问题来源</li><li>✅ 权限滥用检测：监控异常操作</li></ul><h3 id="🔄-迁移指南" tabindex="-1">🔄 迁移指南 <a class="header-anchor" href="#🔄-迁移指南" aria-label="Permalink to &quot;🔄 迁移指南&quot;">​</a></h3><h4 id="前端开发者" tabindex="-1">前端开发者 <a class="header-anchor" href="#前端开发者" aria-label="Permalink to &quot;前端开发者&quot;">​</a></h4><ul><li>✅ <strong>无需任何修改</strong> - API 行为完全一致</li><li>可选：利用新增的审计日志功能构建操作历史页面</li></ul><h4 id="后端开发者" tabindex="-1">后端开发者 <a class="header-anchor" href="#后端开发者" aria-label="Permalink to &quot;后端开发者&quot;">​</a></h4><ul><li>如需扩展用户角色相关功能，统一使用 <code>UserRolesService</code></li><li>需要记录审计日志的操作需传递 <code>actorId</code> 参数</li></ul><h4 id="运维人员" tabindex="-1">运维人员 <a class="header-anchor" href="#运维人员" aria-label="Permalink to &quot;运维人员&quot;">​</a></h4><ul><li>审计日志会占用额外存储空间，建议定期归档或清理</li><li>可通过 <code>audit_logs</code> 表查询用户角色变更历史</li></ul><h3 id="📝-测试清单" tabindex="-1">📝 测试清单 <a class="header-anchor" href="#📝-测试清单" aria-label="Permalink to &quot;📝 测试清单&quot;">​</a></h3><ul><li>[x] TypeScript 类型检查通过</li><li>[x] 构建成功（webpack 编译通过）</li><li>[ ] 单元测试（待补充）</li><li>[ ] 集成测试（待补充）</li><li>[ ] 功能测试（待执行）</li><li>[ ] 审计日志验证（待执行）</li></ul><h3 id="🔙-回滚方案" tabindex="-1">🔙 回滚方案 <a class="header-anchor" href="#🔙-回滚方案" aria-label="Permalink to &quot;🔙 回滚方案&quot;">​</a></h3><p>如遇问题可通过以下方式回滚：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Git 回滚（推荐）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> revert</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">commit-has</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">h</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 或查看详细回滚步骤</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> docs/REFACTOR_USER_ROLES_INTEGRATION.md</span></span></code></pre></div><p>详细回滚步骤参见: <code>docs/REFACTOR_USER_ROLES_INTEGRATION.md</code> 第 9 节</p><h3 id="📚-相关文档" tabindex="-1">📚 相关文档 <a class="header-anchor" href="#📚-相关文档" aria-label="Permalink to &quot;📚 相关文档&quot;">​</a></h3><ul><li><a href="./REFACTOR_USER_ROLES_INTEGRATION.html">完整重构文档</a></li><li><a href="./../apps/backend/src/modules/users/README.html">用户模块文档</a></li><li><a href="./../apps/backend/src/modules/user-roles/README.html">用户角色模块文档</a></li></ul><h3 id="🎖️-贡献者" tabindex="-1">🎖️ 贡献者 <a class="header-anchor" href="#🎖️-贡献者" aria-label="Permalink to &quot;🎖️ 贡献者&quot;">​</a></h3><ul><li>设计 &amp; 实施: Claude Code</li><li>需求提出: 项目团队</li></ul><hr><h2 id="注意事项" tabindex="-1">注意事项 <a class="header-anchor" href="#注意事项" aria-label="Permalink to &quot;注意事项&quot;">​</a></h2><p>⚠️ 本次重构已通过编译验证，但尚未进行完整的功能测试。建议：</p><ol><li>在开发环境充分测试</li><li>验证审计日志记录正常</li><li>检查性能影响可接受</li><li>确认前端功能正常</li><li>准备回滚方案后再部署生产环境</li></ol><hr><p><strong>变更类型</strong>: 重构 (Refactor) <strong>优先级</strong>: 中等 <strong>建议上线时间</strong>: 充分测试后</p>`,46)])])}const c=s(t,[["render",n]]);export{u as __pageData,c as default};
